<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì–´ ë§í•˜ê¸° í˜‘ë™ ìŠ¤í† ë¦¬í…”ëŸ¬</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ë°˜ì‘í˜• ì„¤ì • (Tailwind CSS ëŒ€ì²´) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* ì—°í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        /* ì œëª© ìŠ¤íƒ€ì¼ */
        h1 {
            color: #4a90e2; /* íŒŒë€ìƒ‰ */
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        /* ëª¨ë‘  ì„ íƒ í™”ë©´ */
        #group-selection {
            text-align: center;
            padding: 40px 0;
            /* display: flexë¡œ ì„¤ì •ë˜ì–´ìˆì§€ ì•Šìœ¼ë¯€ë¡œ, JSì—ì„œ block ì‚¬ìš© */
        }

        .input-name-area {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #user-name {
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            width: 80%;
            max-width: 300px;
            text-align: center;
            margin-top: 10px;
        }
        
        .group-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .group-button {
            background-color: #ffc107; /* ë…¸ë€ìƒ‰ ë²„íŠ¼ */
            color: #333;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            /* 6ê°œ ë²„íŠ¼ì´ í•œ ì¤„ì— 3ê°œì”© ë“¤ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ ë„ˆë¹„ ì¡°ì • */
            width: 100px; 
            min-width: 80px;
        }

        .group-button:hover {
            background-color: #ffb300;
            transform: translateY(-2px);
        }

        .secondary-button {
            background-color: #4a90e2; /* íŒŒë€ìƒ‰ ë²„íŠ¼ */
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            width: 100%;
            max-width: 350px;
        }

        .secondary-button:hover {
            background-color: #357bd8;
            transform: translateY(-2px);
        }

        /* ë©”ì¸ ê²Œì„ í™”ë©´ */
        #game-area {
            display: none;
            flex-direction: column;
        }

        #group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            z-index: 10;
        }

        #group-info {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e91e63; /* ë¶„í™ìƒ‰ ê°•ì¡° */
        }
        
        /* í™ˆ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        #home-button, #gallery-home-button {
            background-color: #9c27b0; /* ë³´ë¼ìƒ‰ */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì ì¶”ê°€ */
        }

        #home-button:hover, #gallery-home-button:hover {
            background-color: #7b1fa2;
        }

        /* ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ (ì´ì–´ ë§í•˜ê¸° ë¶€ì‚¬ í‘œì‹œ) */
        #conjunction-canvas {
            width: 100%;
            height: 100px;
            margin-bottom: 15px;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            background-color: #e3f2fd; /* ì—°í•œ íŒŒë€ìƒ‰ */
            box-sizing: border-box;
        }

        /* ìŠ¤í† ë¦¬ë³´ë“œ */
        #storyboard {
            min-height: 250px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 1rem;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        /* ìŠ¤í† ë¦¬ë³´ë“œ ë‚´ ì ‘ì† ë¶€ì‚¬ ê°•ì¡° */
        .conjunction-highlight {
            font-weight: bold;
            color: #4a90e2;
            background-color: #eaf3ff; /* ì—°í•œ íŒŒë€ìƒ‰ ë°°ê²½ */
            padding: 1px 4px;
            border-radius: 4px;
            margin: 0 2px;
        }
        
        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #sentence-input {
            flex-grow: 1;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        #sentence-input:focus {
            border-color: #4a90e2;
            outline: none;
        }

        #submit-button, #save-button {
            background-color: #4CAF50; /* ë…¹ìƒ‰ */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }

        #submit-button:hover, #save-button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        #submit-button:disabled, #save-button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
            transform: none;
        }

        /* ë©”ì‹œì§€ ë°•ìŠ¤ */
        .message-box {
            background-color: #ffe0b2;
            color: #d84315;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        
        /* ì €ì¥ëœ ê¸€ ëª¨ìŒ í™”ë©´ */
        #gallery-area {
            display: none;
            padding: 20px 0;
        }

        .gallery-list {
            list-style: none;
            padding: 0;
        }

        .gallery-list li {
            background-color: #e3f2fd;
            border: 1px solid #c6dafc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .gallery-list li:hover {
            background-color: #bbdefb;
        }

        .gallery-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .detail-content {
            /* ì´ë¯¸ì§€ ì €ì¥ ëŒ€ìƒì´ ë˜ê¸° ë•Œë¬¸ì— padding, background ì„¤ì • */
            background: white;
            padding: 30px; 
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .detail-content h2 {
            color: #e91e63;
            margin-top: 0;
        }

        .detail-content p {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1rem;
        }

        .close-modal-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e91e63;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 2001; /* ë‹«ê¸° ë²„íŠ¼ì´ í•­ìƒ ìœ„ì— ìˆë„ë¡ */
        }
        
        /* ì´ë¯¸ì§€ ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #save-image-button {
            background-color: #00bcd4; /* ì²­ë¡ìƒ‰ */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 20px;
            display: block;
            width: 100%;
            text-align: center;
        }
        
        #save-image-button:hover {
            background-color: #0097a7;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            font-size: 1.2rem;
            color: #4a90e2;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë¯¸ë””ì–´ ì¿¼ë¦¬ (ëª¨ë°”ì¼ ë°˜ì‘í˜•) */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 1.5rem; }
            /* 6ê°œ ë²„íŠ¼ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ ê°„ê²© ì¡°ì • */
            .group-buttons { gap: 10px; }
            .group-button { padding: 12px 10px; width: 80px; font-size: 0.9rem; }
            #storyboard { min-height: 200px; font-size: 0.9rem; }
            .input-area { flex-direction: column; }
            #submit-button { width: 100%; padding: 10px; }
            .detail-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <span id="loading-message">AI ì„ ìƒë‹˜ì´ ë¬¸ë§¥ì„ í™•ì¸ ì¤‘ì´ì—ìš”...</span>
    </div>

    <div class="container">
        <!-- ìˆ˜ì •: ë©”ì¸ ì œëª© ë³€ê²½ -->
        <h1>âœ¨ ì´ì–´ ì£¼ëŠ” ë§ë¡œ ì´ì•¼ê¸° ë§Œë“¤ê¸° âœ¨</h1>

        <!-- 1. ëª¨ë‘  ì„ íƒ í™”ë©´ -->
        <div id="group-selection">
            <div class="input-name-area">
                <p style="font-size: 1.1rem; font-weight: bold;">ğŸ“ ë‚´ ì´ë¦„ (í•„ìˆ˜)</p>
                <input type="text" id="user-name" placeholder="ì—¬ê¸°ì— ì´ë¦„ì„ ì‘ì„±í•˜ì„¸ìš” (ì˜ˆ: ê¹€OO)">
            </div>
            
            <p style="font-size: 1.2rem; margin-bottom: 25px;">í•¨ê»˜ ì´ì•¼ê¸°í•  **ëª¨ë‘  ë²ˆí˜¸**ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
            <div class="group-buttons">
                <button class="group-button" onclick="selectGroup(1)">1 ëª¨ë‘ </button>
                <button class="group-button" onclick="selectGroup(2)">2 ëª¨ë‘ </button>
                <button class="group-button" onclick="selectGroup(3)">3 ëª¨ë‘ </button>
                <button class="group-button" onclick="selectGroup(4)">4 ëª¨ë‘ </button>
                <button class="group-button" onclick="selectGroup(5)">5 ëª¨ë‘ </button>
                <!-- V18 ìˆ˜ì •: 6 ëª¨ë‘  ë²„íŠ¼ ì¶”ê°€ -->
                <button class="group-button" onclick="selectGroup(6)">6 ëª¨ë‘ </button>
            </div>
            
            <button class="secondary-button" onclick="showGallery()">ğŸ“š ìš°ë¦¬ ë°˜ ê¸€ ëª¨ìŒ</button>
            
            <p id="user-id-display" style="margin-top: 30px; font-size: 0.8rem; color: #888;">ì‚¬ìš©ì ID: (ì¸ì¦ í›„ í‘œì‹œë©ë‹ˆë‹¤)</p>
        </div>

        <!-- 2. ë©”ì¸ ê²Œì„ í™”ë©´ -->
        <div id="game-area">
            <div id="group-header">
                <div id="group-info"></div>
                <button id="home-button" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>

            <canvas id="conjunction-canvas"></canvas>
            
            <!-- ì¶”ê°€: ì´ì•¼ê¸° ì œëª© ì…ë ¥ ì˜ì—­ -->
            <div style="margin-bottom: 15px; width: 100%;">
                <input type="text" id="story-title" placeholder="ì´ì•¼ê¸° ì œëª©ì„ ì§€ì–´ì£¼ì„¸ìš”! (ì €ì¥ ì‹œ ì‚¬ìš©)" style="width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 8px; font-size: 1rem; text-align: center;">
            </div>

            <div id="storyboard">
                <!-- ì´ì•¼ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>

            <div id="message-box" class="message-box"></div>

            <div class="input-area">
                <input type="text" id="sentence-input" placeholder="ì—¬ê¸°ì— ì´ì–´ì§ˆ ë¬¸ì¥ì„ ì‘ì„±í•˜ì„¸ìš”." disabled>
                <button id="submit-button" onclick="submitSentence()" disabled>ì œì¶œ</button>
            </div>
            
            <!-- ì €ì¥ ë²„íŠ¼ -->
            <button id="save-button" onclick="saveStory()" disabled style="margin-top: 10px; width: 100%;">ì´ì•¼ê¸° ì™„ì„± ë° ì €ì¥</button>

        </div>
        
        <!-- 3. ì €ì¥ëœ ê¸€ ëª¨ìŒ ê°¤ëŸ¬ë¦¬ í™”ë©´ -->
        <div id="gallery-area">
            <div id="group-header">
                <h2 style="color: #4a90e2; font-size: 1.5rem; margin: 0;">ğŸ“š ìš°ë¦¬ ë°˜ ê¸€ ëª¨ìŒ</h2>
                <!-- ìˆ˜ì •: ê°¤ëŸ¬ë¦¬ í™ˆ ë²„íŠ¼ ë””ìì¸ ê°œì„  -->
                <button id="gallery-home-button" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
            
            <ul id="gallery-list" class="gallery-list">
                <!-- ì €ì¥ëœ ìŠ¤í† ë¦¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
            </ul>
        </div>
    </div>
    
    <!-- 4. ì €ì¥ëœ ê¸€ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
    <div id="gallery-detail-modal" class="gallery-detail-modal" onclick="closeDetailModal(event)">
        <div class="detail-content" onclick="event.stopPropagation()">
            <button class="close-modal-button" onclick="closeDetailModal()">X</button>
            
            <!-- ì €ì¥ëœ ë‚´ìš©ì„ ë³´ì—¬ì£¼ëŠ” ì˜ì—­ -->
            <h2 id="detail-title"></h2>
            <p id="detail-story"></p>
            <p style="font-size: 0.9em; color: #666; margin-top: 20px;">ì°¸ì—¬ í•™ìƒ: <span id="detail-authors"></span></p>

            <!-- ì¶”ê°€: ì´ë¯¸ì§€ ì €ì¥ ë²„íŠ¼ -->
            <button id="save-image-button" onclick="saveDetailAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>


    <!-- Firebase SDK (ìº”ë²„ìŠ¤ í™˜ê²½ í•„ìˆ˜) -->
    <script type="module">
        // í•„ìš”í•œ Firestore í•¨ìˆ˜ë“¤ì„ ëª…ì‹œì ìœ¼ë¡œ importí•©ë‹ˆë‹¤.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // FieldValue ëŒ€ì‹  serverTimestampë¥¼ ì§ì ‘ importí•©ë‹ˆë‹¤.
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, getDocs, addDoc, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë¡œê¹… ì„¤ì • (ë””ë²„ê¹…ìš©)
        setLogLevel('Debug');

        // --- Firebase ì„¤ì •: ê¹ƒí—ˆë¸Œ ë°°í¬ë¥¼ ìœ„í•´ ìˆ˜ë™ìœ¼ë¡œ ê°’ ì…ë ¥ ---
        const appId = 'storyteller1017-92547'; // projectIdì™€ ë™ì¼í•˜ê²Œ ì‚¬ìš©
        const firebaseConfig = {
            apiKey: "AIzaSyCTDmLttgkzwMZ8KM9rWg7hedb9XM08GMw",
            authDomain: "storyteller1017-92547.firebaseapp.com",
            projectId: "storyteller1017-92547",
            storageBucket: "storyteller1017-92547.firebasestorage.app",
            messagingSenderId: "640689321283",
            appId: "1:640689321283:web:18f1a26c7c678d5510abf6",
            measurementId: "G-N0LXCMEXHR"
        };
        const initialAuthToken = null; // ê¹ƒí—ˆë¸Œ ë°°í¬ ì‹œì—ëŠ” ìë™ ì£¼ì…ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ null ì²˜ë¦¬

        let app, db, auth;
        // ì¤‘ìš”: ë¦¬ìŠ¤ë„ˆ í•´ì œ ë³€ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ì„ ì–¸í•˜ì—¬ ëª¨ë“ˆ ì™¸ë¶€ì˜ JSì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì •
        window.unsubscribeSnapshot = null; 
        window.firebaseReady = false;
        
        // ì¤‘ìš”: ëª¨ë“ˆ ì™¸ë¶€ì˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ Firebase í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ window ê°ì²´ì— í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤.
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.updateDoc = updateDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.query = query;
        // ìˆ˜ì •: serverTimestamp í•¨ìˆ˜ë¥¼ window ê°ì²´ì— í• ë‹¹í•©ë‹ˆë‹¤.
        window.serverTimestamp = serverTimestamp;

        
        // Firebase ì´ˆê¸°í™” ë° ì¸ì¦ (ê¹ƒí—ˆë¸Œ ë°°í¬ í™˜ê²½ ë¡œì§)
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.db = db; // ì „ì—­ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •

            onAuthStateChanged(auth, async (user) => {
                let userId;
                if (user) {
                    userId = user.uid;
                } else {
                    // ê¹ƒí—ˆë¸Œ í™˜ê²½ì—ì„œëŠ” initialAuthTokenì´ ì—†ìœ¼ë¯€ë¡œ ìµëª… ë¡œê·¸ì¸ ì‹œë„
                    // --- ì¤‘ìš”: Auth Configuration Error ë°œìƒ ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë¯€ë¡œ ì½˜ì†” ì„¤ì •ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. ---
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        // ìµëª… ë¡œê·¸ì¸ë„ ì‹¤íŒ¨í•˜ë©´ ì„ì‹œ ID ì‚¬ìš© (ìµœí›„ì˜ ìˆ˜ë‹¨)
                        userId = 'temp-user-' + Math.random().toString(36).substring(2, 9);
                    }
                }
                
                window.userId = userId;
                window.firebaseReady = true;
                
                document.getElementById('user-id-display').textContent = `ì‚¬ìš©ì ID: ${userId}`;
                console.log("Firebase initialized and authenticated. User ID:", userId);
            });
        } else {
            // Firebase ì„¤ì •ì´ ì—†ì„ ê²½ìš°, ì„ì‹œ ID ì‚¬ìš©
            window.userId = 'user-' + Math.random().toString(36).substring(2, 9);
            window.firebaseReady = true;
            document.getElementById('user-id-display').textContent = `ì‚¬ìš©ì ID: ${window.userId}`;
        }
        
        // ëª¨ë‘  ë°ì´í„° ê²½ë¡œ ìƒì„± í•¨ìˆ˜
        window.getGroupDocRef = (groupId) => {
            if (!window.db) return null;
            // Public data path: /artifacts/{appId}/public/data/story_rooms/{groupId}
            return doc(window.db, `artifacts/${appId}/public/data/story_rooms/${groupId}`);
        };

        // ì €ì¥ëœ ê¸€ ëª¨ìŒ ì»¬ë ‰ì…˜ ê²½ë¡œ ìƒì„± í•¨ìˆ˜
        window.getGalleryCollectionRef = () => {
            if (!window.db) return null;
            // Public data path: /artifacts/{appId}/public/data/story_gallery
            return collection(window.db, `artifacts/${appId}/public/data/story_gallery`);
        };
    </script>
    
    <script>
        // --- 1. ì „ì—­ ìƒíƒœ ë° ìƒìˆ˜ ì„¤ì • ---
        const CONJUNCTIONS = ['ê·¸ë¦¬ê³ ', 'ê·¸ë˜ì„œ', 'ê·¸ëŸ¬ë‚˜'];
        // V19 ìˆ˜ì •: Gemini API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ë„ë¡ ëª…ì‹œì ìœ¼ë¡œ ë³€ê²½ (ê¹ƒí—ˆë¸Œ ì‚¬ìš© ì‹œ í•„ìˆ˜)
        const API_KEY = "AIzaSyA1_d1_94WT7klF4Ukt0oWs6bdtuv7z6Zs"; // <-- ì—¬ê¸°ì— ì‹¤ì œ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”!
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        let gameState = {
            groupId: null,
            story: [], // { text: string, user: string, conjunction: string, userName: string }
            currentConjunction: 'ê·¸ë¦¬ê³ ',
            isInputActive: false, 
            humanUsers: [], // ëª¨ë‘ ì— ì ‘ì†í•œ ì‹¤ì œ ì‚¬ìš©ì ID
            userName: '', // í˜„ì¬ ì‚¬ìš©ìì˜ ì´ë¦„
            isStorySaved: false, // ìŠ¤í† ë¦¬ ì €ì¥ ì—¬ë¶€
            currentModalStoryTitle: '', // ì´ë¯¸ì§€ ì €ì¥ì„ ìœ„í•œ í˜„ì¬ ëª¨ë‹¬ ì œëª© ì €ì¥
        };

        // DOM ìš”ì†Œ
        const conjunctionCanvas = document.getElementById('conjunction-canvas');
        const ctx = conjunctionCanvas.getContext('2d');
        const storyboardElement = document.getElementById('storyboard');
        const inputElement = document.getElementById('sentence-input');
        const submitButton = document.getElementById('submit-button');
        const messageBox = document.getElementById('message-box');
        const loadingOverlay = document.getElementById('loading-overlay');
        const saveButton = document.getElementById('save-button');
        const userNameInput = document.getElementById('user-name');
        const storyTitleInput = document.getElementById('story-title'); // ì¶”ê°€ëœ ì œëª© ì…ë ¥ì°½
        const detailStoryElement = document.getElementById('detail-story');
        const detailTitleElement = document.getElementById('detail-title');
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • (ë°˜ì‘í˜• ëŒ€ì‘)
        const resizeCanvas = () => {
            conjunctionCanvas.width = conjunctionCanvas.clientWidth;
            conjunctionCanvas.height = conjunctionCanvas.clientHeight;
            drawConjunction();
        };
        window.addEventListener('resize', resizeCanvas);

        // --- 2. ìº”ë²„ìŠ¤ ì ‘ì† ë¶€ì‚¬ í‘œì‹œ (UI) ---
        const drawConjunction = () => {
            const conj = gameState.currentConjunction;
            const width = conjunctionCanvas.width;
            const height = conjunctionCanvas.clientHeight;
            
            ctx.clearRect(0, 0, width, height);
            
            ctx.fillStyle = '#4a90e2';
            ctx.font = 'bold 36px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // ê°•ì¡° íš¨ê³¼ ì¶”ê°€ (ë°°ê²½ ê·¸ë¦¼ì)
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
            ctx.shadowBlur = 5;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            if (gameState.story.length === 0) {
                ctx.fillText('ì´ì•¼ê¸° ì‹œì‘ ë¬¸ì¥ ì…ë ¥!', width / 2, height / 2);
            } else {
                ctx.fillText(`ì´ì–´ ë§í•˜ê¸°: [${conj}]`, width / 2, height / 2);
            }
            
            // ê·¸ë¦¼ì ì´ˆê¸°í™”
            ctx.shadowColor = 'transparent';
        };

        // --- 3. ëª¨ë‘  ì„ íƒ ë° ì´ˆê¸°í™” ë¡œì§ ---
        window.selectGroup = async (groupId) => {
            if (!window.firebaseReady) {
                showMessage("ì•„ì§ ì„œë²„ ì—°ê²° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", 'error');
                return;
            }
            
            // ì´ë¦„ í™•ì¸
            const userName = userNameInput.value.trim();
            if (userName.length < 2) {
                showMessage("ì´ë¦„ì„ ë‘ ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.", 'error');
                return;
            }
            gameState.userName = userName;

            gameState.groupId = groupId;
            document.getElementById('group-selection').style.display = 'none';
            document.getElementById('gallery-area').style.display = 'none';
            document.getElementById('game-area').style.display = 'flex';
            document.getElementById('group-info').textContent = `${groupId} ëª¨ë‘ ì˜ ì´ì•¼ê¸°`;
            
            resizeCanvas();

            await initializeGroupData(groupId);
            setupRealtimeListener(groupId);

            // ì¤‘ìš”: ì´ˆê¸° ì…ë ¥ í™œì„±í™” ì½”ë“œëŠ” onSnapshotì—ì„œ ì²˜ë¦¬ë¨. 
        };
        
        // Firestoreì— ëª¨ë‘  ë°ì´í„° ì´ˆê¸°í™” ë˜ëŠ” ë¡œë“œ
        const initializeGroupData = async (groupId) => {
            const groupRef = window.getGroupDocRef(groupId);
            if (!groupRef) return;

            // getDocì€ window.getDocìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•¨ (module import ë•Œë¬¸)
            const docSnap = await window.getDoc(groupRef);
            
            if (docSnap.exists()) {
                // Case 1: ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
                const data = docSnap.data();
                gameState.story = data.story || [];
                gameState.humanUsers = data.humanUsers || [];
                gameState.isStorySaved = data.isSaved || false;
                
                // í˜„ì¬ ì‚¬ìš©ìê°€ humanUsersì— ì—†ìœ¼ë©´ ì¶”ê°€ (í˜‘ë ¥ì ëª©ë¡ ì—…ë°ì´íŠ¸)
                if (!gameState.humanUsers.includes(window.userId)) {
                    gameState.humanUsers.push(window.userId);
                    // Firestore ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì‚¬ëŒì´ ì ‘ì†í–ˆì„ ë•Œë„ ë°˜ì˜)
                    await window.updateDoc(groupRef, { humanUsers: gameState.humanUsers });
                }
            } else {
                // Case 2: ìƒˆ ë°ì´í„° ì´ˆê¸°í™”
                gameState.story = []; // ë¹ˆ ìŠ¤í† ë¦¬ë¡œ ì‹œì‘
                gameState.humanUsers = [window.userId];
                gameState.isStorySaved = false;
                
                // setDocì€ window.setDocìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•¨
                await window.setDoc(groupRef, {
                    story: gameState.story,
                    humanUsers: gameState.humanUsers,
                    isSaved: false,
                    lastUpdated: Date.now()
                });
            }
            
            // ìŠ¤í† ë¦¬ ê¸¸ì´ì— ë”°ë¥¸ ì ‘ì† ë¶€ì‚¬ ì´ˆê¸° ì„¤ì • (UI ì—…ë°ì´íŠ¸)
            updateConjunctionState();
            renderStory();
            updateSaveButtonState();
        };

        // ì‹¤ì‹œê°„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const setupRealtimeListener = (groupId) => {
            const groupRef = window.getGroupDocRef(groupId);
            if (!groupRef) return;
            
            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ í•´ì œ (window.unsubscribeSnapshot ì‚¬ìš©)
            if (window.unsubscribeSnapshot) {
                window.unsubscribeSnapshot();
                window.unsubscribeSnapshot = null;
            }

            // onSnapshotì€ window.onSnapshotìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•¨
            window.unsubscribeSnapshot = window.onSnapshot(groupRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const newStory = data.story || [];
                    const newUsers = data.humanUsers || [];
                    
                    // ë°ì´í„° ì—…ë°ì´íŠ¸
                    gameState.story = newStory;
                    gameState.humanUsers = newUsers;
                    gameState.isStorySaved = data.isSaved || false;
                    
                    updateConjunctionState();
                    renderStory();
                    updateSaveButtonState();

                    // onSnapshotì—ì„œ ë°ì´í„°ë¥¼ ë°›ì€ í›„ ì…ë ¥ í™œì„±í™” ë³´ì¥
                    activateInput(newStory.length === 0);
                }
            }, (error) => {
                console.error("Firestore Error:", error);
                showMessage("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", 'error');
            });
        };
        
        // í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° ê¸°ëŠ¥
        window.goHome = () => {
            // ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ í•´ì œ (window.unsubscribeSnapshot ì‚¬ìš©)
            if (window.unsubscribeSnapshot) {
                window.unsubscribeSnapshot(); 
                window.unsubscribeSnapshot = null;
            }
            
            // UI ì´ˆê¸°í™”: ëª¨ë‘ ìˆ¨ê¸°ê³  ëª¨ë‘  ì„ íƒ í™”ë©´ë§Œ í‘œì‹œ
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('gallery-area').style.display = 'none';
            document.getElementById('group-selection').style.display = 'block'; 
            
            // ìƒíƒœ ì´ˆê¸°í™”
            gameState.groupId = null;
            gameState.story = [];
            gameState.isStorySaved = false;
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            inputElement.disabled = true;
            submitButton.disabled = true;
            inputElement.value = '';
            storyTitleInput.value = ''; // ì œëª© ì´ˆê¸°í™”
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            drawConjunction();
        };

        // --- 4. ì…ë ¥ ìƒíƒœ ë° ì ‘ì† ë¶€ì‚¬ ê´€ë¦¬ ---
        
        const updateConjunctionState = () => {
            const storyLength = gameState.story.length;
            const isStoryEmpty = storyLength === 0;
            
            // ìŠ¤í† ë¦¬ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì ‘ì† ë¶€ì‚¬ ì—†ìŒ, ì•„ë‹ˆë©´ ìŠ¤í† ë¦¬ ê¸¸ì´ - 1 (0ë¶€í„° ì‹œì‘)ì— ë”°ë¼ ê²°ì •
            const requiredConjunction = isStoryEmpty ? '' : CONJUNCTIONS[(storyLength - 1) % CONJUNCTIONS.length];
            
            gameState.currentConjunction = requiredConjunction;
            drawConjunction();
            
            // í”Œë ˆì´ìŠ¤í™€ë” ì—…ë°ì´íŠ¸
            if (isStoryEmpty) {
                inputElement.placeholder = `ì–´ë–¤ ë¬¸ì¥ìœ¼ë¡œ ì‹œì‘í•´ ë³¼ê¹Œìš”? (ì´ì–´ ë§í•˜ê¸° ì—†ì´ ì‹œì‘)`;
            } else {
                // V15 ìˆ˜ì •: ì´ì œ ì ‘ì† ë¶€ì‚¬ë¥¼ ì…ë ¥í•´ì•¼ í•œë‹¤ê³  ì•ˆë‚´
                inputElement.placeholder = `[${requiredConjunction}]ë¥¼ í¬í•¨í•˜ì—¬ ë¬¸ì¥ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;
            }
        };

        const activateInput = (isStoryEmpty) => {
            // ë¡œë”© ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì…ë ¥ í™œì„±í™” (hideLoadingì—ì„œ ì´ë¯¸ ë¡œë”© ì˜¤ë²„ë ˆì´ëŠ” ì²˜ë¦¬ë¨)
            // showLoading/hideLoading ë¡œì§ì„ ì œì™¸í•˜ê³ ëŠ” í•­ìƒ í™œì„±í™”
            if (loadingOverlay.style.display !== 'flex') {
                gameState.isInputActive = true;
                // ìŠ¤í† ë¦¬ê°€ ì €ì¥ëœ ìƒíƒœë©´ ì…ë ¥ ë¹„í™œì„±í™”
                if (!gameState.isStorySaved) {
                    inputElement.disabled = false;
                    submitButton.disabled = false;
                    storyTitleInput.disabled = false; // ì œëª© ì…ë ¥ì°½ í™œì„±í™”
                } else {
                    inputElement.disabled = true;
                    submitButton.disabled = true;
                    storyTitleInput.disabled = true; // ì œëª© ì…ë ¥ì°½ ë¹„í™œì„±í™”
                }
            }
        };
        
        const updateSaveButtonState = () => {
            if (gameState.story.length >= 3 && !gameState.isStorySaved) {
                saveButton.disabled = false;
                saveButton.textContent = 'ì´ì•¼ê¸° ì™„ì„± ë° ì €ì¥';
                saveButton.style.backgroundColor = '#9c27b0';
            } else if (gameState.isStorySaved) {
                saveButton.disabled = true;
                saveButton.textContent = 'âœ… ì €ì¥ ì™„ë£Œ';
                saveButton.style.backgroundColor = '#4CAF50';
            } else {
                saveButton.disabled = true;
                saveButton.textContent = 'ì´ì•¼ê¸° ì™„ì„± ë° ì €ì¥ (3ë¬¸ì¥ ì´ìƒ)';
                saveButton.style.backgroundColor = '#bdbdbd';
            }
        };
        
        /**
         * ë¬¸ì¥ ë‚´ì—ì„œ ì ‘ì† ë¶€ì‚¬ë¥¼ ì°¾ì•„ HTML íƒœê·¸ë¡œ ê°ì‹¸ ê°•ì¡°í•˜ëŠ” í•¨ìˆ˜
         * @param {string} text í•™ìƒì´ ì…ë ¥í•œ ì „ì²´ ë¬¸ì¥
         * @param {string} conjunction ì°¾ì•„ì•¼ í•  ì ‘ì† ë¶€ì‚¬ (ì˜ˆ: 'ê·¸ë¦¬ê³ ')
         * @returns {string} HTML íƒœê·¸ê°€ ì ìš©ëœ ë¬¸ì¥
         */
        const highlightConjunction = (text, conjunction) => {
            if (!conjunction || text.length === 0) return text;
            
            // V16 ìˆ˜ì •: ë‹¨ì–´ ê²½ê³„(\b)ë¥¼ ì œê±°í•˜ì—¬, 'ê·¸ë¦¬ê³ 'ê°€ ë¬¸ì¥ ì•ì— ì™€ë„ ì¸ì‹í•˜ë„ë¡ ë³€ê²½
            const regex = new RegExp(`(${conjunction})`, 'gi');
            
            // V17: ê´„í˜¸() ëŒ€ì‹  [ ] ì‚¬ìš©. [ $1 ] í˜•íƒœë¡œ ëŒ€ì²´
            return text.replace(regex, `<span class="conjunction-highlight">[ $1 ]</span>`); 
        };


        // --- 5. UI ë° ë©”ì‹œì§€ ê´€ë¦¬ ---
        const renderStory = () => {
            storyboardElement.innerHTML = '';
            let html = '';
            
            if (gameState.story.length === 0) {
                 html += '<p style="color: #888; text-align: center; margin-top: 50px;">ì´ì•¼ê¸°ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”. ëª¨ë‘ ì› ì¤‘ ëˆ„êµ¬ë‚˜ ì²« ë¬¸ì¥ì„ ì…ë ¥í•´ ë³´ì„¸ìš”!</p>';
            } else {
                gameState.story.forEach((item, index) => {
                    const isFirst = index === 0;
                    // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ ë¡œì§
                    let displayUser = item.userName || item.user.substring(0, 8) + '...';
                    if (item.user === window.userId) displayUser = `${item.userName} (ë‚˜)`;

                    if (!isFirst) {
                        // V17 ìˆ˜ì •: ì ‘ì† ë¶€ì‚¬ë¥¼ [ ]ë¡œ ê°ì‹¸ ê°•ì¡°í•˜ë©° ì¶œë ¥
                        const highlightedText = highlightConjunction(item.text, item.conjunction);
                        html += `${highlightedText} <span style="font-size: 0.8em; color: #999;">- ${displayUser}</span><br>`;
                    } else {
                        // V17 ìˆ˜ì •: ì²« ë¬¸ì¥ ì•ì— (ì‹œì‘) íƒœê·¸ ì™„ì „íˆ ì œê±°
                        html += `${item.text} <span style="font-size: 0.8em; color: #999;">- ${displayUser}</span><br>`;
                    }
                });
            }
            
            storyboardElement.innerHTML = html;
            storyboardElement.scrollTop = storyboardElement.scrollHeight; // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
        };
        
        const showMessage = (text, type = 'info') => {
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            messageBox.style.backgroundColor = type === 'error' ? '#ffebee' : '#e3f2fd';
            messageBox.style.color = type === 'error' ? '#c62828' : '#1e88e5';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        };

        // --- 6. ì‚¬ìš©ì ë¬¸ì¥ ì œì¶œ ë¡œì§ ---
        window.submitSentence = async () => {
            if (!gameState.isInputActive || gameState.isStorySaved) {
                showMessage('ì…ë ¥í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. (ì €ì¥ ì™„ë£Œ ë˜ëŠ” ë¡œë”© ì¤‘)', 'error');
                return;
            }
            if (!gameState.userName) {
                 showMessage('ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                 return;
            }

            let sentence = inputElement.value.trim();
            if (sentence.length < 5) {
                showMessage('ë¬¸ì¥ì„ ì¡°ê¸ˆ ë” ê¸¸ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const isFirstSentence = gameState.story.length === 0;
            const conjunction = isFirstSentence ? '' : gameState.currentConjunction;
            
            // ì…ë ¥ ì ê¸ˆ
            inputElement.disabled = true;
            submitButton.disabled = true;
            
            try {
                // V16 ìˆ˜ì •: ì ‘ì† ë¶€ì‚¬ í¬í•¨ ì—¬ë¶€ í™•ì¸ ë¡œì§ (ë‹¨ì–´ ê²½ê³„ \b ì œê±°)
                if (!isFirstSentence) {
                    // ì…ë ¥ ë¬¸ì¥ì— í˜„ì¬ ì ‘ì† ë¶€ì‚¬ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    const regexCheck = new RegExp(`${conjunction}`, 'i');
                    if (!regexCheck.test(sentence)) {
                        showMessage(`ì´ë²ˆ ë¬¸ì¥ì—ëŠ” ê¼­ '${conjunction}'ë¥¼ í¬í•¨í•´ì„œ ì‘ì„±í•´ ì£¼ì„¸ìš”.`, 'error');
                        inputElement.disabled = false;
                        submitButton.disabled = false;
                        return;
                    }
                }
                
                let verificationResult = 'OK';
                
                if (!isFirstSentence && conjunction !== 'ê·¸ë¦¬ê³ ') {
                     // ì²« ë¬¸ì¥ì´ ì•„ë‹ˆë©° 'ê·¸ë¦¬ê³ 'ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë…¼ë¦¬ ê²€ì¦ ìˆ˜í–‰
                     showLoading("ì„ ìƒë‹˜ AIê°€ ë¬¸ë§¥ì„ í™•ì¸ ì¤‘ì´ì—ìš”...");
                     const lastSentence = gameState.story[gameState.story.length - 1].text;
                     // V15 ìˆ˜ì •: í•™ìƒì´ ì…ë ¥í•œ ë¬¸ì¥ ì „ì²´(ì ‘ì† ë¶€ì‚¬ í¬í•¨)ë¥¼ ì „ë‹¬
                     verificationResult = await callGeminiForVerification(lastSentence, sentence, conjunction);
                }
                
                if (verificationResult.startsWith('OK')) {
                    // ì„±ê³µ: ìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
                    const newStoryItem = {
                        text: sentence, // í•™ìƒì´ ì…ë ¥í•œ ë¬¸ì¥ ì „ì²´ (ì ‘ì† ë¶€ì‚¬ í¬í•¨) ì €ì¥
                        user: window.userId,
                        conjunction: conjunction,
                        userName: gameState.userName, // ì´ë¦„ ì €ì¥
                    };
                    
                    const groupRef = window.getGroupDocRef(gameState.groupId);
                    if (groupRef) {
                        // updateDocì€ window.updateDocìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•¨
                        await window.updateDoc(groupRef, {
                            story: [...gameState.story, newStoryItem],
                            lastUpdated: Date.now()
                        });
                        inputElement.value = '';
                        showMessage('ì•„ì£¼ ì¢‹ì•„ìš”! ëª¨ë‘ ì› ëˆ„êµ¬ë‚˜ ë‹¤ìŒ ë¬¸ì¥ì„ ì´ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
                    }
                } else {
                    // ì‹¤íŒ¨: ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ ë° ì…ë ¥ ì ê¸ˆ í•´ì œ
                    const isFirst = gameState.story.length === 0;
                    let errorMsg = `ë¬¸ì¥ì˜ ë…¼ë¦¬ì ì¸ íë¦„ì´ ë§ì§€ ì•Šê±°ë‚˜, '${conjunction}'ë¥¼ ì˜ëª» ì‚¬ìš©í–ˆì–´ìš”. ë‹¤ì‹œ ì‘ì„±í•´ ë³´ì„¸ìš”.`;
                    
                    if (verificationResult.startsWith('FAIL:')) {
                        const hint = verificationResult.substring(5).trim(); // Extract hint after "FAIL:"
                        errorMsg = `ë¬¸ë§¥ì´ ì¡°ê¸ˆ ì–´ìƒ‰í•´ìš”. íŒíŠ¸: ${hint}`;
                    }

                    showMessage(errorMsg, 'error');
                    activateInput(isFirst); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë‹¤ì‹œ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ í•¨
                }
            } catch (error) {
                console.error("Submission Error:", error);
                showMessage("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", 'error');
                activateInput(gameState.story.length === 0); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë‹¤ì‹œ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ í•¨
            } finally {
                hideLoading();
            }
        };
        
        // --- 7. ìŠ¤í† ë¦¬ ì €ì¥ (ê°¤ëŸ¬ë¦¬) ë¡œì§ ---
        window.saveStory = async () => {
            if (gameState.story.length < 3 || gameState.isStorySaved) {
                showMessage("3ë¬¸ì¥ ì´ìƒ ì…ë ¥í•´ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 'error');
                return;
            }
            
            const storyTitle = storyTitleInput.value.trim();
            if (storyTitle.length < 2) {
                showMessage("ì´ì•¼ê¸° ì œëª©ì„ ë‘ ê¸€ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.", 'error');
                storyTitleInput.focus();
                return;
            }

            showLoading("ì´ì•¼ê¸°ë¥¼ 'ìš°ë¦¬ ë°˜ ê¸€ ëª¨ìŒ'ì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...");
            
            try {
                const galleryRef = window.getGalleryCollectionRef();
                const groupRef = window.getGroupDocRef(gameState.groupId);
                
                if (!galleryRef || !groupRef) throw new Error("Firebase ì°¸ì¡° ì˜¤ë¥˜");
                
                // 1. ì°¸ì—¬ì ëª©ë¡ ì •ë¦¬ (ì¤‘ë³µ ì œê±° ë° ì´ë¦„ë§Œ ì¶”ì¶œ)
                const authorNames = [...new Set(gameState.story.map(item => item.userName))];
                
                // 2. ì „ì²´ ìŠ¤í† ë¦¬ í…ìŠ¤íŠ¸ ìƒì„± (ì ‘ì† ë¶€ì‚¬ë¥¼ [ ]ë¡œ ê°ì‹¸ì„œ ì €ì¥)
                const fullStoryText = gameState.story.map((item, index) => {
                    // V17 ìˆ˜ì •: (ì‹œì‘) íƒœê·¸ ì œê±°
                    if (index === 0) {
                        return `${item.text}`;
                    }
                    // V17/V18 ìˆ˜ì •: [ ] ê¸°í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì €ì¥
                    const regex = new RegExp(`(${item.conjunction})`, 'gi'); // ë‹¨ì–´ ê²½ê³„ ì œê±°
                    const textWithBracket = item.text.replace(regex, `[ $1 ]`);
                    return textWithBracket; 
                }).join(' ');

                // 3. ê°¤ëŸ¬ë¦¬ ì»¬ë ‰ì…˜ì— ìƒˆ ë¬¸ì„œ ì¶”ê°€ (addDoc ì‚¬ìš©)
                await window.addDoc(galleryRef, {
                    groupId: gameState.groupId,
                    title: storyTitle, // ì¶”ê°€ëœ ì œëª©
                    fullStory: fullStoryText,
                    authors: authorNames,
                    // ìˆ˜ì •: window.serverTimestamp() í•¨ìˆ˜ë¥¼ ì‚¬ìš©
                    timestamp: window.serverTimestamp() || Date.now(), 
                    firstSentence: gameState.story[0].text,
                });
                
                // 4. í˜„ì¬ ëª¨ë‘  ë¬¸ì„œì— isSaved í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
                await window.updateDoc(groupRef, { isSaved: true });
                
                // gameStateì™€ UIëŠ” onSnapshotì„ í†µí•´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨
                showMessage("ì´ì•¼ê¸°ê°€ 'ìš°ë¦¬ ë°˜ ê¸€ ëª¨ìŒ'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰", 'info');
            } catch (error) {
                console.error("Story Save Error:", error);
                showMessage("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", 'error');
            } finally {
                hideLoading();
            }
        };

        // --- 8. ê°¤ëŸ¬ë¦¬ í™”ë©´ í‘œì‹œ ë° ë¡œë“œ ë¡œì§ ---
        window.showGallery = () => {
            // UI ì „í™˜
            document.getElementById('group-selection').style.display = 'none';
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('gallery-area').style.display = 'block';

            loadGalleryStories();
        };

        const loadGalleryStories = async () => {
            showLoading("ì €ì¥ëœ ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");
            const galleryListElement = document.getElementById('gallery-list');
            galleryListElement.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”
            
            try {
                const galleryRef = window.getGalleryCollectionRef();
                if (!galleryRef) throw new Error("Firebase ì°¸ì¡° ì˜¤ë¥˜");
                
                // ê°¤ëŸ¬ë¦¬ ì»¬ë ‰ì…˜ì˜ ëª¨ë“  ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸° (ì¿¼ë¦¬ëŠ” í˜„ì¬ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
                const q = window.query(galleryRef);
                const querySnapshot = await window.getDocs(q);
                
                if (querySnapshot.empty) {
                    galleryListElement.innerHTML = '<li style="text-align: center; color: #888; background-color: #f0f8ff; cursor: default;">ì•„ì§ ì €ì¥ëœ ì´ì•¼ê¸°ê°€ ì—†ì–´ìš”.</li>';
                    return;
                }

                let listHtml = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const storyId = doc.id;
                    // ìˆ˜ì •: ì €ì¥ëœ titleì„ ì‚¬ìš©í•˜ê³  ì—†ìœ¼ë©´ ì²« ë¬¸ì¥ ì¼ë¶€ë¥¼ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
                    const title = data.title ? data.title : `${data.firstSentence.substring(0, 20)}...`;
                    const displayTitle = `[${data.groupId} ëª¨ë‘ ] ${title}`;
                    
                    // openDetailModal í˜¸ì¶œ ì‹œ ì œëª©ì„ ì „ë‹¬
                    // fullStoryëŠ” ì´ë¯¸ ê´„í˜¸ ì²˜ë¦¬ëœ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
                    listHtml += `<li onclick="openDetailModal('${storyId}', '${displayTitle}', \`${data.fullStory.replace(/`/g, "\\`")}\`, \`${data.authors.join(', ').replace(/`/g, "\\`")}\`)">${displayTitle}</li>`;
                });
                
                galleryListElement.innerHTML = listHtml;
            } catch (error) {
                console.error("Load Gallery Error:", error);
                galleryListElement.innerHTML = '<li style="color: #c62828; background-color: #ffebee; cursor: default;">ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
            } finally {
                hideLoading();
            }
        };
        
        // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        window.openDetailModal = (storyId, groupTitle, fullStory, authors) => {
            detailTitleElement.textContent = groupTitle; // ê·¸ë£¹ íƒ€ì´í‹€ê³¼ ì œëª©ì´ í•©ì³ì ¸ì„œ ë“¤ì–´ì˜´
            detailStoryElement.textContent = fullStory;
            document.getElementById('detail-authors').textContent = authors;
            
            // ì´ë¯¸ì§€ ì €ì¥ì„ ìœ„í•´ í˜„ì¬ ëª¨ë‹¬ ì œëª©ì„ ì €ì¥
            gameState.currentModalStoryTitle = groupTitle.replace(/\[.*\]\s*/, '').trim(); // [X ëª¨ë‘ ] ë¶€ë¶„ì„ ì œê±°
            if (!gameState.currentModalStoryTitle) gameState.currentModalStoryTitle = 'ìš°ë¦¬ë°˜_ì´ì•¼ê¸°';

            document.getElementById('gallery-detail-modal').style.display = 'flex';
        };

        // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        window.closeDetailModal = (event) => {
            // ëª¨ë‹¬ ë°”ê¹¥ìª½ í´ë¦­ ì‹œ ë‹«ê¸°
            if (!event || event.target.id === 'gallery-detail-modal' || event.target.className === 'close-modal-button') {
                document.getElementById('gallery-detail-modal').style.display = 'none';
            }
        };
        
        // --- 9. ì´ë¯¸ì§€ ì €ì¥ ë¡œì§ (HTML ìº¡ì²˜ ëŒ€ì²´) ---
        window.saveDetailAsImage = () => {
            // ìº”ë²„ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ ì´ë¯¸ì§€í™”í•˜ëŠ” ëŒ€ì²´ ë¡œì§
            const storyText = detailStoryElement.textContent;
            const titleText = detailTitleElement.textContent;
            const authorsText = document.getElementById('detail-authors').textContent;

            // ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„± ë° ì„¤ì •
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const padding = 30;
            const lineWidth = 600; 
            const fontSize = 16;
            const titleFontSize = 24;
            const authorFontSize = 14;
            let currentY = padding;
            
            // í…ìŠ¤íŠ¸ë¥¼ ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë¶„í• 
            const storyLines = storyText.split('\n');
            
            // í…ìŠ¤íŠ¸ë¥¼ ìº”ë²„ìŠ¤ ë„ˆë¹„ì— ë§ê²Œ ë¶„í• í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
            const getLines = (text, maxWidth, font) => {
                tempCtx.font = font;
                const words = text.split(' ');
                let lines = [];
                let currentLine = words[0] || '';

                for (let i = 1; i < words.length; i++) {
                    const word = words[i];
                    const width = tempCtx.measureText(currentLine + " " + word).width;
                    if (width < maxWidth) {
                        currentLine += " " + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                }
                lines.push(currentLine);
                return lines;
            };
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ê³„ì‚° (ê°„ë‹¨í•˜ê²Œ)
            const estimatedLineHeight = fontSize * 1.5;
            const estimatedTotalHeight = (storyLines.length * estimatedLineHeight) + 150; // ì œëª© ë° ì—¬ìœ  ê³µê°„ í¬í•¨
            
            tempCanvas.width = lineWidth + 2 * padding;
            tempCanvas.height = estimatedTotalHeight;

            // ë°°ê²½ ì±„ìš°ê¸°
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // ì œëª© ê·¸ë¦¬ê¸°
            tempCtx.fillStyle = '#e91e63';
            tempCtx.font = `bold ${titleFontSize}px Inter`;
            tempCtx.textAlign = 'center';
            currentY += titleFontSize + 10;
            tempCtx.fillText(titleText, tempCanvas.width / 2, currentY);
            
            // êµ¬ë¶„ì„ 
            currentY += 15;
            tempCtx.strokeStyle = '#e91e63';
            tempCtx.lineWidth = 2;
            tempCtx.beginPath();
            tempCtx.moveTo(padding, currentY);
            tempCtx.lineTo(tempCanvas.width - padding, currentY);
            tempCtx.stroke();
            currentY += 20;

            // ìŠ¤í† ë¦¬ ë‚´ìš© ê·¸ë¦¬ê¸°
            tempCtx.fillStyle = '#333333';
            tempCtx.font = `${fontSize}px Inter`;
            tempCtx.textAlign = 'left';
            const storyMaxWidth = lineWidth;

            storyLines.forEach(line => {
                const wrappedLines = getLines(line, storyMaxWidth, `${fontSize}px Inter`);
                wrappedLines.forEach(wrappedLine => {
                    tempCtx.fillText(wrappedLine, padding, currentY);
                    currentY += estimatedLineHeight;
                });
                currentY += estimatedLineHeight * 0.2; // ë‹¨ë½ ê°„ê²©
            });
            
            // ì°¸ì—¬ì ì •ë³´ ê·¸ë¦¬ê¸°
            currentY += 20;
            tempCtx.fillStyle = '#666666';
            tempCtx.font = `${authorFontSize}px Inter`;
            tempCtx.fillText(`ì°¸ì—¬ í•™ìƒ: ${authorsText}`, padding, currentY);
            
            // ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
            const dataURL = tempCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            // ì €ì¥ëœ ì œëª© ì‚¬ìš©
            link.download = `${gameState.currentModalStoryTitle.replace(/[\\/:*?"<>|]/g, '_')}_ì´ì•¼ê¸°.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('ì´ë¯¸ì§€ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'info');
        };

        // --- 10. Gemini API í˜¸ì¶œ í•¨ìˆ˜ (Verification) ---
        
        const callGeminiAPI = async (systemPrompt, userQuery) => {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
                    return text;

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000; // Exponential backoff (1s, 2s, 4s)
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error("Failed to communicate with AI after multiple retries.");
                    }
                }
            }
        };
        
        // 10.1. ë¬¸ì¥ ê²€ì¦ (ì‚¬ìš©ì í„´)
        const callGeminiForVerification = async (lastSentence, newSentence, conjunction) => {
            // V15 ìˆ˜ì •: í•™ìƒì´ ì…ë ¥í•œ ë¬¸ì¥ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬
            const systemPrompt = `You are a helpful language tutor for 3rd-grade students. Your task is to check if a new sentence logically follows the previous sentence using the required conjunction ('ê·¸ë¦¬ê³ ' for simple addition, 'ê·¸ë˜ì„œ' for cause/effect, 'ê·¸ëŸ¬ë‚˜' for contrast/reversal). 
            
            If the sentence is logically correct, respond **ONLY** with 'OK'. 
            
            If the sentence is logically broken, respond **ONLY** with the format: 'FAIL: [Example Sentence Hint using the required conjunction and relevant context from the last sentence. Make the hint encouraging and easy for a 3rd grader.]'. Do not include any other text.`;

            // userQueryì— ì ‘ì† ë¶€ì‚¬ê°€ í¬í•¨ëœ ë¬¸ì¥ ì „ì²´ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
            const userQuery = `ì´ ë¬¸ì¥ì´ ì´ì•¼ê¸°ì˜ íë¦„ì— ë§ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”. ì ‘ì† ë¶€ì‚¬: ${conjunction}. ì• ë¬¸ì¥: "${lastSentence}". ì…ë ¥ ë¬¸ì¥: "${newSentence}".`;
            
            const result = await callGeminiAPI(systemPrompt, userQuery);
            return result.trim(); // Trimmed result is used directly for parsing
        };
        

        // ë¡œë”© í™”ë©´ ì œì–´
        const showLoading = (message) => {
            document.getElementById('loading-message').textContent = message;
            loadingOverlay.style.display = 'flex';
            // ë¡œë”© ì¤‘ì—ëŠ” ì…ë ¥/ë²„íŠ¼ ë¹„í™œì„±í™”
            inputElement.disabled = true;
            submitButton.disabled = true;
        };

        const hideLoading = () => {
            loadingOverlay.style.display = 'none';
            // ë¡œë”©ì´ ëë‚˜ë©´ ë‹¤ì‹œ ì…ë ¥ í™œì„±í™”
            activateInput(gameState.story.length === 0);
        };

        // ì´ˆê¸° ì„¤ì •
        window.onload = () => {
            inputElement.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !inputElement.disabled) {
                    submitSentence();
                }
            });
            resizeCanvas();
        };
    </script>
</body>
</html>
